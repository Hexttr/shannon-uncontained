#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Скачивание файлов последнего пентеста
"""
import paramiko
import sys
import os
from pathlib import Path

if sys.platform == 'win32':
    import codecs
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')

SERVER_HOST = "72.56.79.153"
SERVER_USER = "root"
SERVER_PASSWORD = "m8J@2_6whwza6U"
SERVER_PORT = 22

def connect_to_server():
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        ssh.connect(hostname=SERVER_HOST, port=SERVER_PORT, username=SERVER_USER, password=SERVER_PASSWORD, timeout=10)
        return ssh
    except Exception as e:
        print(f"[ERROR] Ошибка подключения: {e}")
        return None

def find_last_pentest(ssh):
    """Поиск последнего пентеста"""
    print("=" * 70)
    print("ПОИСК ПОСЛЕДНЕГО ПЕНТЕСТА")
    print("=" * 70)
    
    # Находим последний execution-log.json
    stdin, stdout, stderr = ssh.exec_command("find shannon-uncontained/test-output -name 'execution-log.json' -type f 2>/dev/null | xargs ls -t 2>/dev/null | head -1")
    last_log = stdout.read().decode('utf-8').strip()
    
    if not last_log:
        print("❌ Последний пентест не найден")
        return None
    
    # Получаем директорию пентеста
    pentest_dir = os.path.dirname(last_log)
    print(f"\n✅ Найден последний пентест:")
    print(f"   Директория: {pentest_dir}")
    print(f"   Лог: {last_log}")
    
    # Проверяем какая модель использовалась
    print("\n--- Проверка модели ---")
    stdin, stdout, stderr = ssh.exec_command(f"grep -r 'LLM_MODEL\\|model.*claude\\|Using.*model' '{pentest_dir}' 2>/dev/null | head -5")
    model_info = stdout.read().decode('utf-8', errors='ignore')
    if model_info:
        print(model_info)
    
    # Проверяем .env в корне проекта
    stdin, stdout, stderr = ssh.exec_command("grep 'LLM_MODEL' shannon-uncontained/.env 2>/dev/null")
    env_model = stdout.read().decode('utf-8', errors='ignore')
    if env_model:
        print(f"\nМодель из .env: {env_model.strip()}")
    
    return pentest_dir

def download_pentest_files(ssh, pentest_dir):
    """Скачивание файлов пентеста"""
    print("\n" + "=" * 70)
    print("СКАЧИВАНИЕ ФАЙЛОВ ПЕНТЕСТА")
    print("=" * 70)
    
    # Создаем локальную директорию
    local_dir = Path("last_pentest_results")
    local_dir.mkdir(exist_ok=True)
    
    print(f"\nЛокальная директория: {local_dir.absolute()}")
    
    # Файлы для скачивания
    files_to_download = [
        "execution-log.json",
        "world-model.json",
        "README.md",
        "API.md",
        "ARCHITECTURE.md",
        "EVIDENCE.md",
        "manifest.json"
    ]
    
    sftp = ssh.open_sftp()
    
    downloaded = []
    for filename in files_to_download:
        remote_path = f"{pentest_dir}/{filename}"
        local_path = local_dir / filename
        
        try:
            sftp.get(remote_path, str(local_path))
            print(f"✅ {filename}")
            downloaded.append(filename)
        except Exception as e:
            # Файл может не существовать
            if "No such file" not in str(e):
                print(f"⚠️ {filename}: {e}")
    
    # Скачиваем все файлы из директории (если нужно)
    print("\n--- Скачивание всех файлов из директории ---")
    stdin, stdout, stderr = ssh.exec_command(f"find '{pentest_dir}' -type f -name '*.json' -o -name '*.md' -o -name '*.txt' 2>/dev/null | head -20")
    all_files = stdout.read().decode('utf-8', errors='ignore').strip().split('\n')
    
    for file_path in all_files:
        if not file_path:
            continue
        filename = os.path.basename(file_path)
        local_path = local_dir / filename
        
        # Пропускаем если уже скачали
        if filename in downloaded:
            continue
        
        try:
            sftp.get(file_path, str(local_path))
            print(f"✅ {filename}")
        except Exception as e:
            print(f"⚠️ {filename}: {e}")
    
    sftp.close()
    
    print(f"\n✅ Файлы скачаны в: {local_dir.absolute()}")

def check_model_from_log(ssh, pentest_dir):
    """Проверка модели из execution-log.json"""
    print("\n" + "=" * 70)
    print("АНАЛИЗ МОДЕЛИ ИЗ ЛОГОВ")
    print("=" * 70)
    
    # Читаем execution-log.json
    cmd = f"cat '{pentest_dir}/execution-log.json' | python3 -c \"import json,sys; d=json.load(sys.stdin); agents_with_tokens=[a for a in d if a.get('summary',{{}}).get('tokens_used',0)>0]; print('Агентов с токенами:', len(agents_with_tokens)); [print('  - ' + a.get('agent') + ': ' + str(a.get('summary',{{}}).get('tokens_used',0)) + ' токенов') for a in agents_with_tokens]\""
    stdin, stdout, stderr = ssh.exec_command(cmd)
    tokens_info = stdout.read().decode('utf-8', errors='ignore')
    print(tokens_info)
    
    # Проверяем конфигурацию из .env
    print("\n--- Конфигурация из .env ---")
    stdin, stdout, stderr = ssh.exec_command("cat shannon-uncontained/.env | grep -E 'LLM_PROVIDER|LLM_MODEL|ANTHROPIC' | grep -v '^#'")
    env_config = stdout.read().decode('utf-8', errors='ignore')
    print(env_config)
    
    # Проверяем что использовалось в llm-client.js
    print("\n--- Дефолтная модель из llm-client.js ---")
    stdin, stdout, stderr = ssh.exec_command("grep -A 2 'model.*claude-sonnet' shannon-uncontained/src/ai/llm-client.js | head -5")
    llm_model = stdout.read().decode('utf-8', errors='ignore')
    if llm_model:
        print(llm_model)

def main():
    ssh = connect_to_server()
    if not ssh:
        return
    
    try:
        pentest_dir = find_last_pentest(ssh)
        if not pentest_dir:
            return
        
        check_model_from_log(ssh, pentest_dir)
        download_pentest_files(ssh, pentest_dir)
        
        print("\n" + "=" * 70)
        print("ГОТОВО!")
        print("=" * 70)
        print(f"\nФайлы скачаны в: last_pentest_results/")
        print("\nДля просмотра:")
        print("  - execution-log.json - логи выполнения агентов")
        print("  - world-model.json - модель мира")
        print("  - README.md, API.md, ARCHITECTURE.md - документация")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

