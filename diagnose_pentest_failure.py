#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Диагностика проблемы запуска пентеста
"""
import paramiko
import sys

if sys.platform == 'win32':
    import codecs
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')

SERVER_HOST = "72.56.79.153"
SERVER_USER = "root"
SERVER_PASSWORD = "m8J@2_6whwza6U"
SERVER_PORT = 22

def connect_to_server():
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        ssh.connect(hostname=SERVER_HOST, port=SERVER_PORT, username=SERVER_USER, password=SERVER_PASSWORD, timeout=10)
        return ssh
    except Exception as e:
        print(f"[ERROR] Ошибка подключения: {e}")
        return None

def check_web_interface_logs(ssh):
    """Проверка логов веб-интерфейса"""
    print("=" * 70)
    print("ЛОГИ ВЕБ-ИНТЕРФЕЙСА")
    print("=" * 70)
    
    # Последние логи
    print("\n1. Последние 100 строк логов:")
    stdin, stdout, stderr = ssh.exec_command("tail -100 /tmp/web-interface.log 2>/dev/null")
    logs = stdout.read().decode('utf-8', errors='ignore')
    print(logs)
    
    # Ошибки
    print("\n2. Ошибки в логах:")
    stdin, stdout, stderr = ssh.exec_command("grep -i 'error\\|fail\\|exception' /tmp/web-interface.log 2>/dev/null | tail -20")
    errors = stdout.read().decode('utf-8', errors='ignore')
    print(errors if errors else "Ошибок не найдено")

def check_web_interface_status(ssh):
    """Проверка статуса веб-интерфейса"""
    print("\n" + "=" * 70)
    print("СТАТУС ВЕБ-ИНТЕРФЕЙСА")
    print("=" * 70)
    
    # Процессы
    print("\n1. Процессы веб-интерфейса:")
    stdin, stdout, stderr = ssh.exec_command("ps aux | grep 'web-interface' | grep -v grep")
    processes = stdout.read().decode('utf-8', errors='ignore')
    print(processes if processes else "Процессы не найдены")
    
    # Порт
    print("\n2. Порт 3000:")
    stdin, stdout, stderr = ssh.exec_command("netstat -tlnp | grep ':3000' || ss -tlnp | grep ':3000'")
    port = stdout.read().decode('utf-8', errors='ignore')
    print(port if port else "Порт не слушается")

def test_manual_pentest(ssh):
    """Тест ручного запуска пентеста"""
    print("\n" + "=" * 70)
    print("ТЕСТ РУЧНОГО ЗАПУСКА ПЕНТЕСТА")
    print("=" * 70)
    
    # Удаляем старые результаты
    print("\n1. Очистка старых результатов...")
    stdin, stdout, stderr = ssh.exec_command("rm -rf shannon-uncontained/test-output/repos/test.example.com 2>&1")
    cleanup = stdout.read().decode('utf-8', errors='ignore')
    
    # Запускаем пентест
    print("\n2. Запуск пентеста (первые 50 строк вывода):")
    command = """
cd shannon-uncontained && timeout 30 node shannon.mjs generate "https://test.example.com" --output ./test-output 2>&1 | head -50
"""
    stdin, stdout, stderr = ssh.exec_command(command)
    
    output = stdout.read().decode('utf-8', errors='ignore')
    error_output = stderr.read().decode('utf-8', errors='ignore')
    
    print("Вывод:")
    print(output)
    if error_output:
        print("\nОшибки:")
        print(error_output)

def check_web_interface_code(ssh):
    """Проверка кода веб-интерфейса"""
    print("\n" + "=" * 70)
    print("ПРОВЕРКА КОДА ВЕБ-ИНТЕРФЕЙСА")
    print("=" * 70)
    
    # Проверяем синтаксис
    print("\n1. Проверка синтаксиса:")
    stdin, stdout, stderr = ssh.exec_command("cd shannon-uncontained && node -c web-interface.cjs 2>&1")
    syntax = stdout.read().decode('utf-8', errors='ignore')
    print(syntax if syntax else "[OK] Синтаксис корректен")
    
    # Проверяем код очистки
    print("\n2. Проверка кода очистки:")
    stdin, stdout, stderr = ssh.exec_command("grep -A 10 'Cleaning up old results' shannon-uncontained/web-interface.cjs | head -15")
    cleanup_code = stdout.read().decode('utf-8', errors='ignore')
    print(cleanup_code if cleanup_code else "Код очистки не найден")
    
    # Проверяем обработку disconnect
    print("\n3. Проверка обработки disconnect:")
    stdin, stdout, stderr = ssh.exec_command("grep -A 5 'Client disconnected' shannon-uncontained/web-interface.cjs | head -10")
    disconnect_code = stdout.read().decode('utf-8', errors='ignore')
    print(disconnect_code if disconnect_code else "Код disconnect не найден")

def check_recent_errors(ssh):
    """Проверка последних ошибок"""
    print("\n" + "=" * 70)
    print("ПОСЛЕДНИЕ ОШИБКИ")
    print("=" * 70)
    
    # Проверяем системные логи
    print("\n1. Системные логи (последние ошибки):")
    stdin, stdout, stderr = ssh.exec_command("journalctl -n 50 --no-pager 2>/dev/null | grep -i 'error\\|fail' | tail -10 || dmesg | tail -20")
    sys_errors = stdout.read().decode('utf-8', errors='ignore')
    print(sys_errors[:1000] if sys_errors else "Ошибок не найдено")
    
    # Проверяем последний execution-log
    print("\n2. Последний execution-log (ошибки агентов):")
    stdin, stdout, stderr = ssh.exec_command("find shannon-uncontained/test-output -name 'execution-log.json' -type f 2>/dev/null | xargs ls -t 2>/dev/null | head -1")
    last_log = stdout.read().decode('utf-8').strip()
    
    if last_log:
        cmd = f"cat '{last_log}' | python3 -c \"import json,sys; d=json.load(sys.stdin); errors=[a for a in d if not a.get('success',True)]; print('Ошибок:', len(errors)); [print('  - ' + a.get('agent', 'unknown') + ': ' + str(a.get('error', 'unknown'))) for a in errors[:10]]\""
        stdin, stdout, stderr = ssh.exec_command(cmd)
        agent_errors = stdout.read().decode('utf-8', errors='ignore')
        print(agent_errors if agent_errors else "Ошибок агентов не найдено")

def test_web_interface_connection(ssh):
    """Тест подключения к веб-интерфейсу"""
    print("\n" + "=" * 70)
    print("ТЕСТ ПОДКЛЮЧЕНИЯ К ВЕБ-ИНТЕРФЕЙСУ")
    print("=" * 70)
    
    # Проверяем доступность
    print("\n1. Проверка доступности:")
    stdin, stdout, stderr = ssh.exec_command("curl -s -o /dev/null -w '%{http_code}' http://localhost:3000 2>&1")
    http_code = stdout.read().decode('utf-8', errors='ignore').strip()
    print(f"HTTP код: {http_code}")
    
    if http_code == "200":
        print("✅ Веб-интерфейс доступен")
    else:
        print("❌ Веб-интерфейс недоступен")
    
    # Проверяем ответ
    print("\n2. Проверка ответа:")
    stdin, stdout, stderr = ssh.exec_command("curl -s http://localhost:3000 2>&1 | head -20")
    response = stdout.read().decode('utf-8', errors='ignore')
    print(response)

def main():
    ssh = connect_to_server()
    if not ssh:
        return
    
    try:
        check_web_interface_status(ssh)
        check_web_interface_logs(ssh)
        check_web_interface_code(ssh)
        test_web_interface_connection(ssh)
        test_manual_pentest(ssh)
        check_recent_errors(ssh)
        
        print("\n" + "=" * 70)
        print("ДИАГНОСТИКА ЗАВЕРШЕНА")
        print("=" * 70)
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

