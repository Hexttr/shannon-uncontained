#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫ –ø–µ–Ω—Ç–µ—Å—Ç—É - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
"""
import paramiko
import sys
import os

SERVER_IP = "72.56.79.153"
SERVER_USER = "root"
SERVER_PASS = "m8J@2_6whwza6U"

if sys.platform == 'win32':
    os.environ['PYTHONIOENCODING'] = 'utf-8'
    sys.stdout.reconfigure(encoding='utf-8') if hasattr(sys.stdout, 'reconfigure') else None

def connect_server():
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SERVER_IP, username=SERVER_USER, password=SERVER_PASS, timeout=10)
    return ssh

def execute_command(ssh, command, timeout=300):
    try:
        stdin, stdout, stderr = ssh.exec_command(command, timeout=timeout)
        output = stdout.read().decode('utf-8')
        error = stderr.read().decode('utf-8')
        exit_status = stdout.channel.recv_exit_status()
        return exit_status == 0, output, error
    except Exception as e:
        return False, "", str(e)

def main():
    print("=" * 80)
    print("üîß –ü–û–î–ì–û–¢–û–í–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø –ö –ü–ï–ù–¢–ï–°–¢–£")
    print("=" * 80)
    
    ssh = connect_server()
    PROJECT_PATH = "/root/shannon-uncontained"
    
    issues = []
    fixes = []
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    print("\nüìÅ 1. –ü–†–û–í–ï–†–ö–ê –ü–†–û–ï–ö–¢–ê")
    print("-" * 80)
    
    success, output, error = execute_command(ssh, f"test -d {PROJECT_PATH} && echo 'exists' || echo 'not_found'")
    if 'exists' in output:
        print(f"   ‚úÖ –ü—Ä–æ–µ–∫—Ç –Ω–∞–π–¥–µ–Ω: {PROJECT_PATH}")
    else:
        issues.append("–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        print(f"   ‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ shannon.mjs
    success, output, error = execute_command(ssh, f"test -f {PROJECT_PATH}/shannon.mjs && echo 'exists' || echo 'not_found'")
    if 'exists' in output:
        print(f"   ‚úÖ shannon.mjs –Ω–∞–π–¥–µ–Ω")
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
        execute_command(ssh, f"chmod +x {PROJECT_PATH}/shannon.mjs")
    else:
        issues.append("shannon.mjs –Ω–µ –Ω–∞–π–¥–µ–Ω")
        print(f"   ‚ùå shannon.mjs –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ PATH –∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    print("\nüîß 2. –ù–ê–°–¢–†–û–ô–ö–ê PATH –ò –û–ö–†–£–ñ–ï–ù–ò–Ø")
    print("-" * 80)
    
    # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    env_script = f"""#!/bin/bash
export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:$HOME/.cargo/bin:$HOME/.local/bin:/usr/local/bin
export GOPATH=$HOME/go
source $HOME/.cargo/env 2>/dev/null || true
"""
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç
    with ssh.open_sftp() as sftp:
        with sftp.file(f"{PROJECT_PATH}/.env.sh", 'w') as f:
            f.write(env_script)
    
    execute_command(ssh, f"chmod +x {PROJECT_PATH}/.env.sh")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º .bashrc
    print("   –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .bashrc...")
    bashrc_additions = """
# Shannon Pentest Environment
export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:$HOME/.cargo/bin:$HOME/.local/bin:/usr/local/bin
export GOPATH=$HOME/go
source $HOME/.cargo/env 2>/dev/null || true
"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
    success, bashrc_content, _ = execute_command(ssh, "cat ~/.bashrc")
    if 'Shannon Pentest Environment' not in bashrc_content:
        execute_command(ssh, f"echo '{bashrc_additions}' >> ~/.bashrc")
        fixes.append("–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PATH –≤ .bashrc")
        print("   ‚úÖ PATH –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .bashrc")
    else:
        print("   ‚úÖ PATH —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    print("\nüîß 3. –ü–†–û–í–ï–†–ö–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í")
    print("-" * 80)
    
    tools_to_check = {
        'go': 'go version',
        'subfinder': 'subfinder -version',
        'katana': 'katana -version',
        'nuclei': 'nuclei -version',
        'httpx': 'httpx -version',
        'nmap': 'nmap --version',
        'whatweb': 'whatweb --version',
    }
    
    env_cmd = "export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:$HOME/.cargo/bin:$HOME/.local/bin:/usr/local/bin && export GOPATH=$HOME/go"
    
    for tool, check_cmd in tools_to_check.items():
        success, output, error = execute_command(ssh, f"bash -c '{env_cmd} && {check_cmd} 2>&1 | head -1'")
        if success and output.strip() and 'not found' not in (output + error).lower():
            print(f"   ‚úÖ {tool}: {output.strip()[:50]}")
        else:
            print(f"   ‚ùå {tool}: –Ω–µ –Ω–∞–π–¥–µ–Ω")
            issues.append(f"{tool} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ Ollama
    print("\nü§ñ 4. –ü–†–û–í–ï–†–ö–ê OLLAMA")
    print("-" * 80)
    
    success, output, error = execute_command(ssh, "curl -s http://localhost:11434/api/tags 2>&1 | head -5")
    if success and 'models' in output.lower() or 'codellama' in output.lower():
        print("   ‚úÖ Ollama —Ä–∞–±–æ—Ç–∞–µ—Ç")
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–µ–ª—å
        success2, models, _ = execute_command(ssh, "ollama list")
        if 'codellama' in models.lower():
            print("   ‚úÖ –ú–æ–¥–µ–ª—å codellama –¥–æ—Å—Ç—É–ø–Ω–∞")
        else:
            print("   ‚ö†Ô∏è  –ú–æ–¥–µ–ª—å codellama –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            fixes.append("–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å: ollama pull codellama:7b")
    else:
        print("   ‚ùå Ollama –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç")
        issues.append("Ollama –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
        fixes.append("–ó–∞–ø—É—Å—Ç–∏—Ç—å Ollama: ollama serve")
    
    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
    print("\n‚öôÔ∏è  5. –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò")
    print("-" * 80)
    
    success, env_content, _ = execute_command(ssh, f"cat {PROJECT_PATH}/.env 2>/dev/null || echo 'NOT_FOUND'")
    if 'NOT_FOUND' in env_content or not env_content.strip():
        print("   ‚ö†Ô∏è  .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é...")
        env_content = """LLM_PROVIDER=ollama
LLM_MODEL=codellama:7b
"""
        with ssh.open_sftp() as sftp:
            with sftp.file(f"{PROJECT_PATH}/.env", 'w') as f:
                f.write(env_content)
        fixes.append("–°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª")
        print("   ‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω")
    else:
        print("   ‚úÖ .env —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        if 'LLM_PROVIDER=ollama' in env_content:
            print("   ‚úÖ Ollama –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env")
        else:
            print("   ‚ö†Ô∏è  Ollama –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env")
            fixes.append("–û–±–Ω–æ–≤–∏—Ç—å .env –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Ollama")
    
    # 6. –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
    print("\nüß™ 6. –¢–ï–°–¢–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê")
    print("-" * 80)
    
    test_cmd = f"cd {PROJECT_PATH} && export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:$HOME/.cargo/bin:$HOME/.local/bin:/usr/local/bin && export GOPATH=$HOME/go && ./shannon.mjs --help 2>&1 | head -10"
    success, output, error = execute_command(ssh, test_cmd)
    if success and output.strip():
        print("   ‚úÖ –ö–æ–º–∞–Ω–¥–∞ shannon.mjs —Ä–∞–±–æ—Ç–∞–µ—Ç")
        print(f"   {output.strip()[:200]}")
    else:
        print("   ‚ùå –ö–æ–º–∞–Ω–¥–∞ shannon.mjs –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
        print(f"   –û—à–∏–±–∫–∞: {error[:200]}")
        issues.append("shannon.mjs –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    
    # 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    print("\nüåê 7. –ü–†–û–í–ï–†–ö–ê –í–ï–ë-–ò–ù–¢–ï–†–§–ï–ô–°–ê")
    print("-" * 80)
    
    success, output, error = execute_command(ssh, "ps aux | grep 'web-interface.cjs' | grep -v grep")
    if success and output.strip():
        print("   ‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø—É—â–µ–Ω")
    else:
        print("   ‚ö†Ô∏è  –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞—é...")
        execute_command(ssh, f"cd {PROJECT_PATH} && nohup node web-interface.cjs > /tmp/web-interface.log 2>&1 &")
        import time
        time.sleep(2)
        print("   ‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–ø—É—â–µ–Ω")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
    success, output, error = execute_command(ssh, "ss -tlnp 2>/dev/null | grep :3000 || netstat -tlnp 2>/dev/null | grep :3000")
    if success and output.strip():
        print("   ‚úÖ –ü–æ—Ä—Ç 3000 —Å–ª—É—à–∞–µ—Ç—Å—è")
    else:
        print("   ‚ö†Ô∏è  –ü–æ—Ä—Ç 3000 –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # 8. –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–µ–Ω—Ç–µ—Å—Ç–∞
    print("\nüìù 8. –°–û–ó–î–ê–ù–ò–ï –°–ö–†–ò–ü–¢–ê –ó–ê–ü–£–°–ö–ê")
    print("-" * 80)
    
    run_script = f"""#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–µ–Ω—Ç–µ—Å—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º
cd {PROJECT_PATH}
source .env.sh
export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:$HOME/.cargo/bin:$HOME/.local/bin:/usr/local/bin
export GOPATH=$HOME/go
source $HOME/.cargo/env 2>/dev/null || true

TARGET="$1"
if [ -z "$TARGET" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run-pentest.sh <target_url>"
    exit 1
fi

echo "–ó–∞–ø—É—Å–∫ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –¥–ª—è: $TARGET"
./shannon.mjs generate "$TARGET" --workspace ./test-output
"""
    
    with ssh.open_sftp() as sftp:
        with sftp.file(f"{PROJECT_PATH}/run-pentest.sh", 'w') as f:
            f.write(run_script)
    
    execute_command(ssh, f"chmod +x {PROJECT_PATH}/run-pentest.sh")
    print("   ‚úÖ –°–∫—Ä–∏–ø—Ç run-pentest.sh —Å–æ–∑–¥–∞–Ω")
    
    ssh.close()
    
    # –†–µ–∑—é–º–µ
    print("\n" + "=" * 80)
    print("üìä –†–ï–ó–Æ–ú–ï")
    print("=" * 80)
    
    if issues:
        print(f"\n‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: {len(issues)}")
        for issue in issues:
            print(f"   - {issue}")
    else:
        print("\n‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    if fixes:
        print(f"\nüîß –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: {len(fixes)}")
        for fix in fixes:
            print(f"   - {fix}")
    
    print("\n" + "=" * 80)
    print("‚úÖ –ì–û–¢–û–í–û –ö –ü–ï–ù–¢–ï–°–¢–£")
    print("=" * 80)
    print("""
üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://72.56.79.153:3000

üìù –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –≤–µ–±:
   1. –û—Ç–∫—Ä–æ–π—Ç–µ http://72.56.79.153:3000
   2. –í–≤–µ–¥–∏—Ç–µ URL —Ü–µ–ª–∏
   3. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å"

üìù –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ SSH:
   ssh root@72.56.79.153
   cd /root/shannon-uncontained
   ./run-pentest.sh https://example.com

üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:
   tail -f /tmp/web-interface.log
""")

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

